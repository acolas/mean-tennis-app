/*! mean 2014-07-20 */
angular.module("mean",["ngCookies","ngResource","ui.bootstrap","ui.route","ui.chart","mean.system","mean.games","mean.users"]),angular.module("mean.system",[]),angular.module("mean.games",[]),angular.module("mean.users",[]),angular.module("mean").config(["$routeProvider",function(a){a.when("/games",{templateUrl:"views/games/list.html"}).when("/rules",{templateUrl:"views/rules/view.html"}).when("/stack",{templateUrl:"views/stack/view.html"}).when("/games/create",{templateUrl:"views/games/create.html"}).when("/games/:gameId",{templateUrl:"views/games/view.html"}).when("/users/:userId",{templateUrl:"views/users/view.html"}).when("/",{templateUrl:"views/index.html"}).otherwise({redirectTo:"/"})}]),angular.module("mean").config(["$locationProvider",function(a){a.hashPrefix("!")}]),angular.module("mean.games").controller("GamesController",["$scope","$routeParams","$location","Global","Games","Users",function(a,b,c,d,e,f){a.global=d,a.create=function(){this.victory=!1,this.myScore>this.opponentScore&&(this.victory=!0);for(var a=[],b=[],d=0;d<this.score.options.length;d++)a.push(this.score.options[d].scoreOpponent1),b.push(this.score.options[d].scoreOpponent2);this.score.option_new.scoreOpponent1&&a.push(this.score.option_new.scoreOpponent1),this.score.option_new.scoreOpponent2&&b.push(this.score.option_new.scoreOpponent2);var f=new e({score:{scoreOpponent1:a,scoreOpponent2:b},opponent:{_id:this.opponentUser._id},details:{victory:this.victory,typeOfGame:this.details.typeOfGame,points:0},date:this.date});this.user&&(f.user={_id:this.user._id}),f.$save(function(a){c.path("games/"+a._id)}),this.opponentUser="",this.myScore="",this.opponentScore="",this.victory=!1,this.points=0},a.find=function(){e.query(function(b){a.games=b})},a.findOne=function(){e.get({gameId:b.gameId},function(b){a.game=b})},a.findOneUser=function(){f.get({userId:a.game.opponent.user},function(b){a.game.opponent.user=b})},a.findUsers=function(){f.query(function(b){a.users=[],jQuery.each(b,function(){d.user._id!==this._id&&a.users.push(this)})})},a.findAllUsers=function(){f.query(function(b){a.allUsers=b})},a.showWeeks=!0,a.toggleWeeks=function(){a.showWeeks=!a.showWeeks},a.clear=function(){a.dt=null},a.open=function(b){b.preventDefault(),b.stopPropagation(),a.opened=!0},a.dateOptions={"year-format":"'yy'","starting-day":1},a.score={options:[],option_new:{scoreOpponent1:"",scoreOpponent2:""}},a.add=function(){a.score.options.push(a.score.option_new),a.score.option_new={scoreOpponent1:"",scoreOpponent2:""}}}]),angular.module("mean.system").controller("HeaderController",["$scope","Global",function(a,b){a.global=b,a.menu=[{title:"Saisir un score",link:"games/create"},{title:"Historique",link:"games"},{title:"Règlement",link:"rules"},{title:"À propos",link:"stack"}],a.isCollapsed=!1}]),angular.module("mean.system").controller("IndexController",["$scope","Global","Games","Users",function(a,b,c,d){a.global=b;var e={};a.quantity=10;var f=function(a){var b=a.reduce(function(a,b){return b[0]in a.nums?a.nums[b[0]][1]+=b[1]:(a.nums[b[0]]=b,a.result.push(b)),a},{nums:{},result:[]}).result.sort(function(a,b){return a[0]-b[0]});return b};a.find=function(){a.gamesFiltered=[],d.query(function(d){a.allUsers=d,c.query(function(c){a.usersArray=[],jQuery.each(c,function(d){var f=jQuery.grep(a.usersArray,function(a){return a._id===c[d].user._id});0===f.length&&(a.usersArray.push(c[d].user),e[c[d].user.email]=[],e["rank_"+c[d].user.email]=[]);var g=jQuery.grep(a.usersArray,function(a){return a._id===c[d].opponent.user._id});0===g.length&&(a.usersArray.push(c[d].opponent.user),e[c[d].opponent.user.email]=[],e["rank_"+c[d].opponent.user.email]=[]);var h=[],i=[],j=0,k=moment.parseZone(this.date).add("days",1).format("DD-MMM-YYYY");h.push(k),i.push(k),h.push(c[d].details.points);var l=0;c[d].details.victory?(e[c[d].user.email].push(h),l=e["rank_"+c[d].user.email].length-1,j=void 0===e["rank_"+c[d].user.email][0]?c[d].details.points:e["rank_"+c[d].user.email][l][1]+c[d].details.points,i.push(j),e["rank_"+c[d].user.email].push(i)):(e[c[d].opponent.user.email].push(h),l=e["rank_"+c[d].opponent.user.email].length-1,j=void 0===e["rank_"+c[d].opponent.user.email][0]?c[d].details.points:e["rank_"+c[d].opponent.user.email][l][1]+c[d].details.points,i.push(j),e["rank_"+c[d].opponent.user.email].push(i)),(c[d].opponent.user._id===b.user._id||c[d].user._id===b.user._id)&&a.gamesFiltered.push(c[d]),jQuery.each(a.usersArray,function(b){void 0==a.usersArray[b].numberOfGames&&(a.usersArray[b].numberOfGames=0),(c[d].opponent.user.firstName===a.usersArray[b].firstName||c[d].user.firstName===a.usersArray[b].firstName)&&a.usersArray[b].numberOfGames++})}),a.userNumberOfVictories=[],a.chartUserResults=[],a.chartUserRanks=[],a.chartUserRanksScore=[],jQuery.each(a.usersArray,function(b){a.usersArray[b].userNumberOfVictories=e[a.usersArray[b].email].length,a.usersArray[b].chartUserResults=f(e[a.usersArray[b].email]),a.usersArray[b].chartUserRanks=e["rank_"+a.usersArray[[b]].email],a.usersArray[b].chartUserRanksScore=[e["rank_"+a.usersArray[b].email][e["rank_"+a.usersArray[b].email].length-1][1],a.usersArray[b].rank]}),a.chartOptionsDateAndScore={cursor:{show:!0,zoom:!0,looseZoom:!0,showTooltip:!1},title:"Nombre de points gagnés par date",axes:{xaxis:{renderer:jQuery.jqplot.DateAxisRenderer,tickOptions:{formatString:"%d/%m/%Y"}}},legend:{show:!0,location:"ne",xoffset:12,yoffset:12},series:[{label:a.usersArray[3].firstName},{label:a.usersArray[2].firstName},{label:a.usersArray[1].firstName},{label:a.usersArray[0].firstName}],highlighter:{show:!0,showLabel:!0,tooltipAxes:"y",sizeAdjust:7.5,tooltipLocation:"ne"}},a.chartOptionsDateAndRank={cursor:{show:!0,zoom:!0,looseZoom:!0,showTooltip:!1},title:"Classement par date",axes:{xaxis:{renderer:jQuery.jqplot.DateAxisRenderer,tickOptions:{formatString:"%d/%m/%Y"}}},legend:{show:!0,location:"se",xoffset:12,yoffset:12},series:[{label:a.usersArray[3].firstName},{label:a.usersArray[2].firstName},{label:a.usersArray[1].firstName},{label:a.usersArray[0].firstName},{lineWidth:4,markerOptions:{style:"square"}}],highlighter:{show:!0,showLabel:!0,tooltipAxes:"y",sizeAdjust:7.5,tooltipLocation:"ne"}}})})}}]),angular.module("mean.users").controller("UsersController",["$scope","$routeParams","$location","Global","Users",function(a,b,c,d,e){a.global=d,a.update=function(){var b=a.user;b.updated||(b.updated=[]),b.updated.push((new Date).getTime()),b.$update(function(){c.path("users/"+b._id)})},a.find=function(){e.query(function(b){a.users=b})},a.findOne=function(){e.get({userId:b.userId},function(b){a.user=b})}}]),angular.module("ui.chart",[]).directive("uiChart",function(){return{restrict:"EACM",template:"<div></div>",replace:!0,link:function(a,b,c){var d=function(){var d=a.$eval(c.uiChart);if(b.html(""),angular.isArray(d)){var e={};if(!angular.isUndefined(c.chartOptions)&&(e=a.$eval(c.chartOptions),!angular.isObject(e)))throw"Invalid ui.chart options attribute";b.jqplot(d,e)}};a.$watch(c.uiChart,function(){d()},!0),a.$watch(c.chartOptions,function(){d()})}}}),angular.element(document).ready(function(){"#_=_"==window.location.hash&&(window.location.hash=""),angular.bootstrap(document,["mean"])}),angular.module("mean.games").factory("Games",["$resource",function(a){return a("games/:gameId",{gameId:"@_id"},{update:{method:"PUT"}})}]),angular.module("mean.system").factory("Global",[function(){var a=this;return a._data={user:window.user,authenticated:!!window.user},a._data}]),angular.module("mean.system").factory("Index",["$resource",function(a){return a("index/:gameId",{gameId:"@_id"})}]),angular.module("mean.users").factory("Users",["$resource",function(a){return a("users/:userId",{userId:"@_id"},{update:{method:"PUT"}})}]);